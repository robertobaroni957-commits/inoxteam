<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTER WINTER TOUR 2025/26 - Official Hub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="sidebar.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        zwift: { dark: '#111111', card: '#1e1e24', orange: '#fc6719', blue: '#00f0ff', text: '#f0f0f0', gray: '#888888' },
                        race: { flat: '#10b981', mountain: '#ef4444', hilly: '#f59e0b', time: '#00f0ff', }
                    },
                    fontFamily: { display: ['Teko', 'sans-serif'], body: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        .chart-container { position: relative; width: 100%; max-width: 500px; height: 350px; margin: 0 auto; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e24; }
        ::-webkit-scrollbar-thumb { background: #fc6719; border-radius: 4px; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col bg-zwift-dark font-body text-zwift-text">

    <nav class="bg-zwift-card border-b border-gray-800 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-2xl font-bold tracking-wider font-display text-zwift-orange">MASTER WINTER TOUR <span class="text-white text-lg font-light">25/26</span></div>
            <div class="hidden lg:flex space-x-6 text-sm font-semibold">
                <a href="#dashboard" id="nav-dashboard" class="hover:text-zwift-orange transition">Dashboard</a>
                <a href="#stages" id="nav-stages" class="hover:text-zwift-orange transition">Tappe</a>
                <a href="#analytics" id="nav-analytics" class="hover:text-zwift-orange transition">Analisi</a>
                <a href="#ranking" id="nav-ranking" class="hover:text-zwift-orange transition text-zwift-orange font-bold">Classifiche</a>
            </div>
            <div class="flex space-x-3 items-center">
                <a href="regolamento.html" class="bg-zwift-orange hover:bg-orange-600 text-white font-bold py-1 px-4 rounded text-sm transition hidden sm:block"><i class="fas fa-scroll mr-1"></i> REGOLAMENTO</a>
                <a href="#ranking" class="bg-zwift-blue hover:bg-cyan-500 text-black font-bold py-1 px-4 rounded text-sm transition hidden sm:block">CLASSIFICHE</a>
                <a href="https://www.zwift.com/eu-it/events/tag/inoxwinter" target="_blank" class="bg-zwift-orange hover:bg-orange-600 text-white font-bold py-3 px-4 rounded text-center mt-4 transition text-sm">ISCRIVITI ORA</a>
                <button id="menu-toggle" class="text-white text-2xl lg:hidden focus:outline-none ml-3">
                    <span id="menu-icon-open"><i class="fas fa-bars"></i></span>
                    <span id="menu-icon-close" class="hidden"><i class="fas fa-times"></i></span>
                </button>
            </div>
        </div>
    </nav>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black z-40 transition-opacity duration-300 lg:hidden"></div>
    <div id="sidebar" class="lg:hidden shadow-2xl">
        <div class="p-4 border-b border-gray-700 sticky top-0 bg-[#1a1d20]">
            <div class="flex items-center space-x-2">
                <img src="https://www.teaminox.it/wp-content/uploads/2023/11/cropped-INOX-semplice-colore-lineare.png" class="h-8" alt="Logo INOX">
                <span class="text-2xl font-bold tracking-wider font-display text-zwift-orange">INOX</span>
            </div>
        </div>
        <div class="flex flex-col p-2 space-y-1 text-base font-semibold">
            <div class="border-b border-gray-700 pb-2 mb-2"><p class="text-xs text-gray-500 uppercase px-3 py-1">Questa Pagina</p><a href="#dashboard" class="sidebar-link">Dashboard</a><a href="#stages" class="sidebar-link">Tappe</a><a href="#analytics" class="sidebar-link">Analisi</a><a href="#ranking" class="sidebar-link">Classifiche</a></div>
            <div class="border-b border-gray-700 pb-2 mb-2"><p class="text-xs text-gray-500 uppercase px-3 py-1">Area Riservata</p><a href="index.html" class="sidebar-link">Login/Accesso</a><a href="registrazione.html" class="sidebar-link">Registrazione</a></div>
            <div class="border-b border-gray-700 pb-2 mb-2"><p class="text-xs text-gray-500 uppercase px-3 py-1">Team INOX</p><a href="chi_siamo.html" class="sidebar-link">Chi Siamo / Filosofia</a><a href="contatti.html" class="sidebar-link">Contatti</a></div>
            <div class="border-b border-gray-700 pb-2 mb-2"><p class="text-xs text-gray-500 uppercase px-3 py-1">AttivitÃ  Team</p><a href="eventi.html" class="sidebar-link">Calendario Eventi</a><a href="mwt_page.html" class="sidebar-link">Master Winter Tour</a><a href="regolamento.html" class="sidebar-link">Regolamento</a><a href="zrl_page.html" class="sidebar-link">ZRL Roster (API)</a></div>
            <a href="https://www.zwift.com/eu-it/events/tag/inoxwinter" target="_blank" class="bg-zwift-orange hover:bg-orange-600 text-white font-bold py-3 px-4 rounded text-center mt-4 transition text-sm">ISCRIVITI A ZWIFT EVENTS</a>
        </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <header id="dashboard" class="relative py-16 min-h-[50vh] flex items-center justify-center overflow-hidden bg-gradient-to-b from-zwift-card to-zwift-dark">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-6xl md:text-8xl font-bold mb-4 leading-none text-white drop-shadow-lg font-display">
                DOMINA <span class="text-transparent bg-clip-text bg-gradient-to-r from-zwift-orange to-red-500">L'INVERNO</span>
            </h1>
            <p class="text-xl md:text-2xl text-zwift-gray mb-8 max-w-2xl mx-auto font-light drop-shadow-md">
                18 Gare. 1 Campione. La competizione indoor definitiva su Zwift inizia il 12 Dicembre.
            </p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-3xl mx-auto mb-10 text-zwift-blue">
                <div class="bg-zwift-card/80 p-4 rounded-lg border border-gray-700 backdrop-blur-sm"><span id="days" class="text-4xl font-bold font-display block">00</span><span class="text-xs text-gray-400 uppercase tracking-widest">Giorni</span></div>
                <div class="bg-zwift-card/80 p-4 rounded-lg border border-gray-700 backdrop-blur-sm"><span id="hours" class="text-4xl font-bold font-display block">00</span><span class="text-xs text-gray-400 uppercase tracking-widest">Ore</span></div>
                <div class="bg-zwift-card/80 p-4 rounded-lg border border-gray-700 backdrop-blur-sm"><span id="minutes" class="text-4xl font-bold font-display block">00</span><span class="text-xs text-gray-400 uppercase tracking-widest">Minuti</span></div>
                <div class="bg-zwift-card/80 p-4 rounded-lg border border-gray-700 backdrop-blur-sm"><span id="seconds" class="text-4xl font-bold font-display block">00</span><span class="text-xs text-gray-400 uppercase tracking-widest">Secondi</span></div>
            </div>
            <div id="next-race-info" class="text-zwift-orange font-bold text-lg mb-4 animate-pulse">PROSSIMA GARA: Caricamento...</div>
        </div>
    </header>
    <section id="analytics" class="py-12 bg-zwift-dark">
        <div class="container mx-auto px-4">
            <div class="mb-10 text-center md:text-left">
                <h2 class="text-4xl font-bold mb-2 font-display">ANALISI DEL TOUR</h2>
                <p class="text-gray-400">Studia il terreno. Prepara l'attrezzatura. Ecco cosa ti aspetta nelle 18 tappe.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-zwift-card p-6 rounded-xl border border-gray-800 shadow-lg">
                    <h3 class="text-2xl text-zwift-blue mb-4 font-display">Tipologie di Gara</h3>
                    <div class="chart-container"><canvas id="raceTypeChart"></canvas></div>
                    <p class="text-xs text-center text-gray-500 mt-4">Distribuzione delle specialitÃ  su 18 tappe.</p>
                </div>
                <div class="bg-zwift-card p-6 rounded-xl border border-gray-800 shadow-lg flex flex-col justify-center">
                    <h3 class="text-2xl text-zwift-orange mb-6 font-display">Statistiche Chiave</h3>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="text-center p-4 bg-black/30 rounded-lg"><div class="text-5xl font-bold text-white font-display">18</div><div class="text-sm text-gray-400 uppercase">Tappe Totali</div></div>
                        <div class="text-center p-4 bg-black/30 rounded-lg"><div class="text-5xl font-bold text-white font-display">6</div><div class="text-sm text-gray-400 uppercase">Settimane</div></div>
                        <div class="text-center p-4 bg-black/30 rounded-lg"><div class="text-5xl font-bold text-white font-display">8</div><div class="text-sm text-gray-400 uppercase">Mondi Zwift</div></div>
                        <div class="text-center p-4 bg-black/30 rounded-lg"><div class="text-5xl font-bold text-white font-display">5</div><div class="text-sm text-gray-400 uppercase">Tappe di Montagna</div></div>
                    </div>
                    <div class="mt-6 p-4 border-l-4 border-zwift-blue bg-black/20"><p class="text-sm text-gray-300 italic">"Il tour Ã¨ bilanciato per premiare l'atleta completo: esplosivitÃ  per gli sprint, resistenza per le lunghe distanze e rapporto w/kg per le montagne."</p></div>
                </div>
            </div>
        </div>
    </section>
    <section id="stages" class="py-12 bg-zwift-card">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 border-b border-gray-700 pb-4">
                <div>
                    <h2 class="text-4xl font-bold text-white font-display">CALENDARIO TAPPE</h2>
                    <p class="text-gray-400">Esplora e registrati. Clicca su una tappa per i dettagli del percorso (Zwift Insider).</p>
                </div>
                <div class="flex space-x-2 mt-4 md:mt-0">
                    <select id="worldFilter" class="bg-zwift-dark text-white border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-zwift-orange"><option value="all">Tutti i Mondi</option></select>
                    <select id="typeFilter" class="bg-zwift-dark text-white border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-zwift-orange"><option value="all">Tutti i Tipi</option></select>
                </div>
            </div>
            <div id="stage-list" class="grid grid-cols-1 gap-4"></div>
        </div>
    </section>

    <section id="ranking" class="py-12 bg-zwift-dark">
        <div class="container mx-auto px-4">
            <div class="mb-8 border-b border-gray-700 pb-4">
                <h2 class="text-4xl font-bold text-white font-display">CLASSIFICHE TOUR</h2>
                <p class="text-gray-400">Seleziona una categoria e un tipo di classifica per visualizzare i risultati aggiornati.</p>
            </div>
            
            <div class="flex space-x-4 mb-4 flex-wrap items-center bg-zwift-card p-4 rounded-lg border border-gray-700">
                <div class="flex items-center space-x-2">
                    <label for="selectGaraRanking" class="text-gray-400 text-sm font-semibold">Gara:</label>
                    <select id="selectGaraRanking" class="bg-zwift-dark text-white border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-zwift-orange">
                        <option value="cumulative">Generale (Cumulata)</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <label class="text-gray-400 text-sm font-semibold">Categoria:</label>
                    <div class="flex space-x-1">
                        <button data-category="A" class="category-btn bg-zwift-orange text-white font-bold py-2 px-4 rounded text-sm transition">A</button>
                        <button data-category="B" class="category-btn bg-zwift-card hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-sm transition">B</button>
                        <button data-category="C" class="category-btn bg-zwift-card hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-sm transition">C</button>
                        <button data-category="D" class="category-btn bg-zwift-card hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-sm transition">D</button>
                        <button data-category="E" class="category-btn bg-zwift-card hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-sm transition">E</button>
                    </div>
                </div>
            </div>

            <div class="flex space-x-3 mb-8 flex-wrap border-t border-gray-700 pt-4">
                <button data-type="punti" class="type-btn bg-zwift-orange text-white font-bold py-2 px-4 rounded-lg text-sm transition mb-2">Punti Generali</button>
                <button data-type="tempo" class="type-btn bg-zwift-card hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition mb-2">Tempo</button>
                <button data-type="sprinter" class="type-btn bg-zwift-card hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition mb-2">Punti Sprinter</button>
                <button data-type="scalatore" class="type-btn bg-zwift-card hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition mb-2">Punti Scalatore</button>
            </div>
            <div id="ranking-container" class="bg-zwift-card p-6 rounded-xl border border-gray-800 shadow-lg min-h-[300px] relative">
            </div>
        </div>
    </section>
    
    <footer class="bg-black py-8 border-t border-gray-800"><!-- footer content --></footer>
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden"><!-- modal content --></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Original page logic for stages, countdown, etc.
            const tourStages = [
                { id: 1, date: "2025-12-12T19:20:00", world: "Scotland", route: "Outer Scotland (2 laps - 22 km)", type: "Point Hilly", routeLink: "https://zwiftinsider.com/route/outer-scotland/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247620", segments: ["primo Champion Sprint solo FTS", "primo Breakaway Brae reverse solo FTS", "primo Clyde Kicker FAL e FTS", "secondo Champion Sprint FAL e FTS", "secondo Breakaway Brae reverse solo FAL", "secondo Clyde Kicker FAL e FTS", "terzo Champion Sprint FAL e FTS"] },
                { id: 2, date: "2025-12-16T19:20:00", world: "Makuri", route: "Red Zone Repeats (1 lap - 19.6 km - 87 mt +)", type: "iTT", routeLink: "https://zwiftinsider.com/route/red-zone-repeats/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247622", segments: [] },
                { id: 3, date: "2025-12-19T19:20:00", world: "New York", route: "Issendorf Express", type: "Luna Park", routeLink: "https://zwiftinsider.com/route/issendorf-express/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247623", segments: [] },
                { id: 4, date: "2025-12-23T19:20:00", world: "Scotland", route: "City and the Sgurr", type: "Point Mountain", routeLink: "https://zwiftinsider.com/route/city-and-the-sgurr/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247624", segments: [] },
                { id: 5, date: "2025-12-27T19:20:00", world: "Bologna", route: "Time Trial Lap", type: "Chrono Scalata", routeLink: "https://zwiftinsider.com/route/bologna-time-trial-lap/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247628", segments: [] },
                { id: 6, date: "2025-12-30T19:20:00", world: "London", route: "Classique Reverse", type: "Point Flat", routeLink: "https://zwiftinsider.com/route/classique-reverse/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247630", segments: [] },
                { id: 7, date: "2026-02-13T19:20:00", world: "Makuri", route: "Sprinter's Playground", type: "Luna Park", routeLink: "https://zwiftinsider.com/route/sprinters-playground/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247687", segments: [] },
                { id: 8, date: "2026-02-17T19:20:00", world: "London", route: "London Uprising", type: "Point Mountain", routeLink: "https://zwiftinsider.com/route/london-uprising/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247689", segments: [] },
                { id: 9, date: "2026-02-20T19:20:00", world: "Watopia", route: "Flat Out Fast", type: "iTT", routeLink: "https://zwiftinsider.com/route/flat-out-fast/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247692", segments: [] },
                { id: 10, date: "2026-02-24T19:20:00", world: "France", route: "Bon Voyage", type: "Point Flat", routeLink: "https://zwiftinsider.com/route/bon-voyage/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247696", segments: [] },
                { id: 11, date: "2026-02-27T19:20:00", world: "Watopia", route: "Mountain Mash", type: "Chrono Scalata", routeLink: "https://zwiftinsider.com/route/mountain-mash/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247700", segments: [] },
                { id: 12, date: "2026-03-04T19:20:00", world: "Richmond", route: "Cobbled Climbs Reverse", type: "Point Hilly", routeLink: "https://zwiftinsider.com/route/cobbled-climbs-reverse/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247701", segments: [] },
                { id: 13, date: "2026-03-07T19:20:00", world: "London", route: "London Flat", type: "iTT", routeLink: "https://zwiftinsider.com/route/london-flat/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247703", segments: [] },
                { id: 14, date: "2026-03-11T19:20:00", world: "New York", route: "Toefield Tormado", type: "Luna Park", routeLink: "https://zwiftinsider.com/route/toefield-tormado/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247705", segments: [] },
                { id: 15, date: "2026-03-14T19:20:00", world: "Watopia", route: "Power Punches", type: "Point Mountain", routeLink: "https://zwiftinsider.com/route/power-punches/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247707", segments: [] },
                { id: 16, date: "2026-03-18T19:20:00", world: "Makuri", route: "Electric Loop", type: "Point Flat", routeLink: "https://zwiftinsider.com/route/electric-loop/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247709", segments: [] },
                { id: 17, date: "2026-03-21T19:20:00", world: "France", route: "Ven-10", type: "Chrono Scalata", routeLink: "https://zwiftinsider.com/route/ven-10/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247710", segments: [] },
                { id: 18, date: "2026-03-25T19:20:00", world: "Watopia", route: "Jarvis Seaside Sprint", type: "Point Hilly", routeLink: "https://zwiftinsider.com/route/jarvis-seaside-sprint/", registerLink: "https://www.zwift.com/eu-it/events/tag/inoxwinter/view/5247712", segments: [] }
            ];
            const formatDate = (dateString) => { const options = { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }; return new Date(dateString).toLocaleDateString('it-IT', options); };
            const getTypeIcon = (type) => { type = type.toLowerCase(); if (type.includes('flat')) return 'âš¡'; if (type.includes('mountain')) return 'ðŸ”ï¸'; if (type.includes('hilly')) return 'â›°ï¸'; if (type.includes('luna park')) return 'ðŸ”„'; if (type.includes('itt') || type.includes('chrono scalata')) return 'â±ï¸'; return 'ðŸš´'; };
            const getTypeColor = (type) => { type = type.toLowerCase(); if (type.includes('flat')) return 'text-race-flat'; if (type.includes('mountain')) return 'text-race-mountain'; if (type.includes('hilly')) return 'text-race-hilly'; return 'text-race-time'; };
            initCountdown(); initChart(); populateFilters(); renderStages();
            function initCountdown() {
                const firstStageDate = new Date(tourStages[0].date).getTime();
                const countdownInterval = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = firstStageDate - now;

                    if (distance < 0) {
                        clearInterval(countdownInterval);
                        document.getElementById('days').innerText = '00';
                        document.getElementById('hours').innerText = '00';
                        document.getElementById('minutes').innerText = '00';
                        document.getElementById('seconds').innerText = '00';
                        document.getElementById('next-race-info').innerText = 'TOUR IN CORSO O COMPLETATO';
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    document.getElementById('days').innerText = String(days).padStart(2, '0');
                    document.getElementById('hours').innerText = String(hours).padStart(2, '0');
                    document.getElementById('minutes').innerText = String(minutes).padStart(2, '0');
                    document.getElementById('seconds').innerText = String(seconds).padStart(2, '0');

                    // Find next race info
                    const nextRace = tourStages.find(stage => new Date(stage.date).getTime() > now);
                    if (nextRace) {
                        document.getElementById('next-race-info').innerHTML = `PROSSIMA GARA: ${formatDate(nextRace.date)} - ${nextRace.route} (${nextRace.world})`;
                    } else {
                        document.getElementById('next-race-info').innerText = 'Tutte le gare sono state completate!';
                    }

                }, 1000);
            }

            function initChart() {
                const raceTypes = tourStages.map(stage => stage.type);
                const typeCounts = raceTypes.reduce((acc, type) => {
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});

                const labels = Object.keys(typeCounts);
                const data = Object.values(typeCounts);
                const backgroundColors = [
                    'rgba(16, 185, 129, 0.7)', // flat (green)
                    'rgba(239, 68, 68, 0.7)',  // mountain (red)
                    'rgba(245, 158, 11, 0.7)', // hilly (orange)
                    'rgba(0, 240, 255, 0.7)',  // time (blue)
                    'rgba(100, 100, 255, 0.7)' // Luna Park (purple)
                ];

                const ctx = document.getElementById('raceTypeChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors.slice(0, labels.length),
                            borderColor: '#1e1e24',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#f0f0f0',
                                    font: { size: 14 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(tooltipItem) {
                                        const total = tooltipItem.dataset.data.reduce((a, b) => a + b, 0);
                                        const currentValue = tooltipItem.raw;
                                        const percentage = ((currentValue / total) * 100).toFixed(1);
                                        return `${tooltipItem.label}: ${currentValue} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function populateFilters() {
                const worlds = [...new Set(tourStages.map(stage => stage.world))];
                const types = [...new Set(tourStages.map(stage => stage.type))];

                const worldFilter = document.getElementById('worldFilter');
                worlds.forEach(world => {
                    const option = document.createElement('option');
                    option.value = world;
                    option.textContent = world;
                    worldFilter.appendChild(option);
                });

                const typeFilter = document.getElementById('typeFilter');
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeFilter.appendChild(option);
                });

                worldFilter.addEventListener('change', () => renderStages());
                typeFilter.addEventListener('change', () => renderStages());
            }

            function renderStages() {
                const stageList = document.getElementById('stage-list');
                stageList.innerHTML = ''; // Clear previous stages

                const worldFilter = document.getElementById('worldFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;

                const filteredStages = tourStages.filter(stage => {
                    const matchesWorld = (worldFilter === 'all' || stage.world === worldFilter);
                    const matchesType = (typeFilter === 'all' || stage.type === typeFilter);
                    return matchesWorld && matchesType;
                });

                if (filteredStages.length === 0) {
                    stageList.innerHTML = `<p class="text-gray-400 text-center py-8">Nessuna tappa trovata per i filtri selezionati.</p>`;
                    return;
                }

                filteredStages.forEach(stage => {
                    const stageCardHtml = `
                        <div class="bg-zwift-dark p-4 rounded-lg border border-gray-700 shadow-md flex flex-col md:flex-row justify-between items-start md:items-center cursor-pointer stage-card" data-stage-id="${stage.id}">
                            <div class="mb-3 md:mb-0">
                                <h3 class="text-xl font-bold text-zwift-orange font-display">Tappa ${stage.id}: ${stage.route}</h3>
                                <p class="text-gray-400 text-sm">${formatDate(stage.date)}</p>
                                <p class="text-gray-300 text-sm">${stage.world} - <span class="${getTypeColor(stage.type)} font-semibold">${getTypeIcon(stage.type)} ${stage.type}</span></p>
                            </div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <a href="${stage.routeLink}" target="_blank" class="bg-zwift-card hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-sm transition text-center flex items-center justify-center">
                                    <i class="fas fa-route mr-2"></i> Dettagli Percorso
                                </a>
                                <a href="${stage.registerLink}" target="_blank" class="bg-zwift-orange hover:bg-orange-600 text-white font-bold py-2 px-4 rounded text-sm transition text-center flex items-center justify-center">
                                    <i class="fas fa-clipboard-list mr-2"></i> Iscriviti
                                </a>
                            </div>
                        </div>
                    `;
                    stageList.innerHTML += stageCardHtml;
                });

                // Attach event listeners to newly rendered stage cards
                document.querySelectorAll('.stage-card').forEach(card => {
                    card.addEventListener('click', (event) => {
                        // Prevent opening modal if a link inside the card was clicked
                        if (event.target.tagName === 'A' || event.target.closest('a')) {
                            return;
                        }
                        const stageId = parseInt(card.dataset.stageId);
                        openStageModal(stageId);
                    });
                });
            }
            
            function openStageModal(stageId) {
                const modal = document.getElementById('event-modal');
                const stage = tourStages.find(s => s.id === stageId);

                if (!stage) {
                    console.error('Stage not found for ID:', stageId);
                    return;
                }

                // Conditionally render segments
                const segmentsHtml = stage.segments && stage.segments.length > 0 ?
                    `<div class="mt-4">
                        <h4 class="text-xl font-bold text-zwift-blue font-display mb-2">Segmenti Rilevanti:</h4>
                        <ul class="list-disc list-inside text-gray-300 ml-4">
                            ${stage.segments.map(segment => `<li>${segment}</li>`).join('')}
                        </ul>
                    </div>` : '';

                // Populate modal content
                let modalContent = `
                    <div class="bg-zwift-card p-6 rounded-xl border border-gray-800 shadow-lg w-11/12 max-w-2xl relative">
                        <button class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl" id="close-event-modal">&times;</button>
                        <h3 class="text-3xl font-bold text-zwift-orange font-display mb-4">Tappa ${stage.id}: ${stage.route}</h3>
                        <p class="text-gray-300 text-lg mb-2"><strong>Data:</strong> ${formatDate(stage.date)}</p>
                        <p class="text-gray-300 text-lg mb-2"><strong>Mondo:</strong> ${stage.world}</p>
                        <p class="text-gray-300 text-lg mb-4"><strong>Tipo:</strong> <span class="${getTypeColor(stage.type)} font-semibold">${getTypeIcon(stage.type)} ${stage.type}</span></p>
                        
                        ${segmentsHtml}

                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 mt-4">
                            <a href="${stage.routeLink}" target="_blank" class="bg-zwift-dark hover:bg-gray-700 text-white font-bold py-3 px-4 rounded text-center transition flex items-center justify-center text-base">
                                <i class="fas fa-route mr-2"></i> Dettagli Percorso
                            </a>
                            <a href="${stage.registerLink}" target="_blank" class="bg-zwift-orange hover:bg-orange-600 text-white font-bold py-3 px-4 rounded text-center transition flex items-center justify-center text-base">
                                <i class="fas fa-clipboard-list mr-2"></i> Iscriviti
                            </a>
                        </div>
                    </div>
                `;
                // If "segments and other info" implies additional data for the modal that is not currently in tourStages,
                // this is where you would fetch or generate that content. For now, using existing data.

                modal.innerHTML = modalContent;
                modal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden'); // Prevent scrolling while modal is open

                document.getElementById('close-event-modal').addEventListener('click', closeStageModal);
            }

            function closeStageModal() {
                const modal = document.getElementById('event-modal');
                modal.classList.add('hidden');
                modal.innerHTML = ''; // Clear modal content on close
                document.body.classList.remove('overflow-hidden');
            }

            // Call this once on DOMContentLoaded to set up initial listeners for elements that persist
            function setupModalListeners() {
                // This function can be expanded if there are other global elements that trigger the modal
                // or if modal-related listeners need to be attached outside of renderStages for any reason.
            }


            // RANKING LOGIC
            let currentCategory = 'A';
            let currentType = 'punti'; 
            let currentStage = 'cumulative'; 

            const secondsToHms = (d) => {
                if (d === undefined || d === null || isNaN(d) || d === 0) return "--:--:--";
                const h = Math.floor(d / 3600);
                const m = Math.floor((d % 3600) / 60);
                const s = Math.round(d % 60);
                const pad = (num) => String(num).padStart(2, '0');
                return `${pad(h)}:${pad(m)}:${pad(s)}`;
            };

            const parseNameAndTeam = (fullName) => {
                let team = '';
                let name = fullName.trim();
                const regex = /\s*(\(|\[|&lt;)([^)\]&gt;]+)(\)|\]|&gt;)\s*$/;
                const match = name.match(regex);
                if (match) { team = match[2]; name = name.replace(match[0], '').trim(); }
                name = name.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\s*&#\d+;|\s*[\u2600-\u26FF]|\s*[\u2700-\u27BF]/g, '').trim();
                return { name, team: team || 'Individuale' };
            };

            const updateCategoryButtons = (activeCategory) => {
                document.querySelectorAll('.category-btn').forEach(button => {
                    if (button.dataset.category === activeCategory) {
                        button.classList.add('bg-zwift-orange', 'font-bold'); button.classList.remove('bg-zwift-card');
                    } else {
                        button.classList.add('bg-zwift-card'); button.classList.remove('bg-zwift-orange', 'font-bold');
                    }
                });
            };

            const updateTypeButtons = (activeType) => {
                document.querySelectorAll('.type-btn').forEach(button => {
                    if (button.dataset.type === activeType) {
                        button.classList.add('bg-zwift-orange', 'font-bold'); button.classList.remove('bg-zwift-card');
                    } else {
                        button.classList.add('bg-zwift-card'); button.classList.remove('bg-zwift-orange', 'font-bold');
                    }
                });
            };
            
            const renderRankingTable = (data, type, category, stage) => {
                const isCumulative = (stage === 'cumulative');
                let title, headers, scoreKey, unit;

                const singleRaceKeys = { punti: 'punti_total', tempo: 'tempo_time', sprinter: 'sprinter_points', scalatore: 'climber_points' };
                const cumulativeKeys = { punti: 'total', tempo: 'time', sprinter: 'pts_sprint', scalatore: 'pts_kom' };

                if (type === 'punti') { title = `Punti`; headers = ['Pos', 'Atleta', 'Squadra', 'Punti']; unit = ' Pts'; }
                else if (type === 'tempo') { title = `Tempo`; headers = ['Pos', 'Atleta', 'Squadra', 'Tempo']; unit = ''; }
                else if (type === 'sprinter') { title = `Punti Sprint`; headers = ['Pos', 'Atleta', 'Squadra', 'Punti Sprint']; unit = ' Pts'; }
                else if (type === 'scalatore') { title = `Punti Scalatore`; headers = ['Pos', 'Atleta', 'Squadra', 'Punti Scalata']; unit = ' Pts'; }
                else { return `<p class="text-red-500">Tipo classifica non valido.</p>`; }

                scoreKey = isCumulative ? cumulativeKeys[type] : singleRaceKeys[type];
                title = isCumulative ? `${title} Generali` : `Gara ${stage} - ${title}`;

                const sortedData = [...data].sort((a, b) => {
                    const scoreA = a[scoreKey] || 0;
                    const scoreB = b[scoreKey] || 0;
                    if (type === 'tempo') { return (scoreA || Infinity) - (scoreB || Infinity); }
                    return scoreB - scoreA;
                });

                let html = `<h2 class="text-2xl text-zwift-blue mb-4 font-display">${title} - Cat. ${category}</h2>
                            <div class="overflow-x-auto"><table class="min-w-full table-auto text-left whitespace-nowrap"><thead><tr class="bg-black/50">
                            ${headers.map(h => `<th class="px-4 py-2 border-b-2 border-zwift-orange">${h}</th>`).join('')}
                            </tr></thead><tbody>`;
                
                if (sortedData.length === 0) {
                     html += `<tr><td colspan="${headers.length}" class="text-center py-8 text-gray-500">Nessun dato disponibile per questa selezione.</td></tr>`;
                } else {
                    sortedData.forEach((athlete, index) => {
                        const { name: athleteName, team } = parseNameAndTeam(athlete.name);
                        const rank = index + 1;
                        let scoreDisplay = athlete[scoreKey] || 0;
                        if (type === 'tempo') { scoreDisplay = secondsToHms(scoreDisplay); }
                        else { scoreDisplay += unit; }
                        let rowStyle = '', rankColor = 'text-white', medalIcon = '';
                        if (rank === 1) { rowStyle = 'background-color: rgba(255, 215, 0, 0.2);'; rankColor = 'text-yellow-400'; medalIcon = 'ðŸ¥‡ '; }
                        else if (rank === 2) { rowStyle = 'background-color: rgba(192, 192, 192, 0.2);'; rankColor = 'text-gray-300'; medalIcon = 'ðŸ¥ˆ '; }
                        else if (rank === 3) { rowStyle = 'background-color: rgba(205, 127, 50, 0.2);'; rankColor = 'text-amber-500'; medalIcon = 'ðŸ¥‰ '; }

                        html += `<tr class="hover:bg-black/30" style="${rowStyle}">
                                    <td class="px-4 py-3 font-bold ${rankColor}">${medalIcon}${rank}</td>
                                    <td class="px-4 py-3 font-semibold text-white">${athleteName}</td>
                                    <td class="px-4 py-3 text-gray-400">${team}</td>
                                    <td class="px-4 py-3 font-bold text-zwift-orange">${scoreDisplay}</td>
                                 </tr>`;
                    });
                }
                html += `</tbody></table></div>`;
                return html;
            };

            const loadRanking = async (category, type, stage) => {
                currentCategory = category;
                currentType = type;
                currentStage = stage;
                
                updateCategoryButtons(category);
                updateTypeButtons(type);
                document.getElementById('selectGaraRanking').value = stage;
                
                const container = document.getElementById('ranking-container');
                container.innerHTML = `<div class="text-gray-500 absolute inset-0 flex items-center justify-center">Caricamento classifica...</div>`;
                
                try {
                    const isCumulative = stage === 'cumulative';
                    const dataUrl = isCumulative ? 'cumulative_results.json' : `gara_${stage}_results.json`;
                    
                    const response = await fetch(dataUrl);
                    if (!response.ok) throw new Error(`File non trovato: ${dataUrl}`);
                    
                    const allRankings = await response.json();
                    
                    let dataToRender;
                    if (isCumulative) {
                        dataToRender = allRankings[category] || [];
                    } else {
                        if (Array.isArray(allRankings)) {
                            dataToRender = allRankings.filter(rider => rider.category === category);
                        } else if (typeof allRankings === 'object' && allRankings !== null) {
                            dataToRender = (allRankings[category] && allRankings[category][type]) ? allRankings[category][type] : [];
                        } else {
                            throw new Error("Formato JSON della gara singola non riconosciuto.");
                        }
                    }
                    
                    container.innerHTML = renderRankingTable(dataToRender, type, category, stage);

                } catch (error) {
                    console.error("Errore caricamento classifica:", error);
                    container.innerHTML = `<p class="text-red-500 text-lg p-10">Impossibile caricare la classifica. Assicurati che i file JSON per la gara selezionata siano presenti nella directory principale. (Dettaglio: ${error.message})</p>`;
                }
            };

            const initRankingListeners = () => {
                const selectGaraRanking = document.getElementById('selectGaraRanking');
                const stageNames = Array.from({length: 18}, (_, i) => `Gara ${i + 1}`);
                stageNames.forEach((name, index) => {
                    selectGaraRanking.appendChild(new Option(name, index + 1));
                });

                selectGaraRanking.addEventListener('change', (e) => {
                    loadRanking(currentCategory, currentType, e.target.value);
                });

                document.querySelectorAll('.category-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const stage = document.getElementById('selectGaraRanking').value;
                        loadRanking(e.target.dataset.category, currentType, stage);
                    });
                });
                
                document.querySelectorAll('.type-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const stage = document.getElementById('selectGaraRanking').value;
                        loadRanking(currentCategory, e.target.dataset.type, stage); 
                    });
                });
            };

            initRankingListeners();
            loadRanking('A', 'punti', 'cumulative'); 
            

        });
    </script>
    <script src="sidebar.js"></script>
    <script src="mwt_page_logic.js"></script>
</body>
</html>