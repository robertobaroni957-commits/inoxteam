<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classifiche Masters Winter Tour 2025/26</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="sidebar.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        zwift: { dark: '#111111', card: '#1e1e24', orange: '#fc6719', blue: '#00f0ff', text: '#f0f0f0', gray: '#888888' },
                        race: { flat: '#10b981', mountain: '#ef4444', hilly: '#f59e0b', time: '#00f0ff', }
                    },
                    fontFamily: { display: ['Teko', 'sans-serif'], body: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        /* Ensure main content is flex and takes full width on mobile, and shifts on desktop */
        body { display: flex; min-height: 100vh; flex-direction: column; }

        @media (min-width: 1024px) {
            body { flex-direction: row; } /* Desktop layout with sidebar beside content */
            body > nav { /* Target the direct child nav of body */
                margin-left: 300px;
                width: calc(100% - 300px); /* Ensure it doesn't overflow */
            }
            #main-content { margin-left: 300px; }
        }

        /* Styles for the language toggle header */
        .lang-toggle {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .lang-btn {
            border: none;
            background: transparent;
            font-size: 1.25rem; /* text-xl */
            cursor: pointer;
            padding: 0.375rem; /* p-1.5 */
            border-radius: 0.375rem; /* rounded-md */
            color: #d1d5db; /* gray-300 */
        }
        .lang-btn[aria-pressed="true"] {
            outline: 2px solid rgba(0, 102, 34, 0.2); /* Accent green, transparent */
            background: rgba(0, 102, 34, 0.1); /* Accent green, transparent */
            color: #fc6719; /* zwift-orange to highlight active */
        }
        .lang-btn:focus { box-shadow: 0 0 0 3px rgba(252, 103, 25, 0.3); /* zwift-orange focus */ }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col bg-zwift-dark font-body text-zwift-text">

    <nav class="bg-zwift-card border-b border-gray-800 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-2xl font-bold tracking-wider font-display text-zwift-orange">MASTER WINTER TOUR <span class="text-white text-lg font-light">2025/26</span></div>
                        <div class="flex space-x-3 items-center">
                            <!-- Language buttons top-right -->
                            <div class="lang-toggle" aria-label="Language selection">
                                <button class="lang-btn" id="btn-it" aria-pressed="true" title="Italiano" aria-label="Italiano">ðŸ‡®ðŸ‡¹</button>
                                <button class="lang-btn" id="btn-en" aria-pressed="false" title="English" aria-label="English">ðŸ‡¬ðŸ‡§</button>
                            </div>
                            <button id="menu-toggle" class="text-white text-2xl lg:hidden focus:outline-none ml-3">
                                <span id="menu-icon-open"><i class="fas fa-bars"></i></span>
                                <span id="menu-icon-close" class="hidden"><i class="fas fa-times"></i></span>
                            </button>
                        </div>
                    </div>
                </nav>
                
    <div id="sidebar-overlay" class="fixed inset-0 bg-black z-40 transition-opacity duration-300 hidden"></div>
    <div id="sidebar" class="fixed top-0 left-0 w-72 h-full bg-[#1a1d20] shadow-2xl z-50 transform -translate-x-full transition-transform duration-300 ease-in-out">
        <div class="p-4 border-b border-gray-700 sticky top-0 bg-[#1a1d20]">
            <div class="flex items-center space-x-2">
                <img src="https://www.teaminox.it/wp-content/uploads/2023/11/cropped-INOX-semplice-colore-lineare.png" class="h-8" alt="Logo INOX">

            </div>
        </div>
        <div class="flex flex-col p-2 space-y-1 text-base font-semibold">
            <div class="border-b border-gray-700 pb-2 mb-2">
                <div class="lang-it">
                    <p class="text-xs text-gray-500 uppercase px-3 py-1">Navigazione</p>
                    <a href="mwt_page.html" class="sidebar-link">Masters Winter Tour</a>
                    <a href="regolamento.html" class="sidebar-link">Regolamento</a>
                    <a href="Leaders.html" class="sidebar-link">Leaders del Tour</a>
                    <a href="ranking.html" class="sidebar-link">Classifiche</a>
                </div>
                <div class="lang-en" hidden>
                    <p class="text-xs text-gray-500 uppercase px-3 py-1">Navigation</p>
                    <a href="mwt_page.html" class="sidebar-link">Masters Winter Tour</a>
                    <a href="regolamento.html" class="sidebar-link">Rules</a>
                    <a href="Leaders.html" class="sidebar-link">Tour Leaders</a>
                    <a href="ranking.html" class="sidebar-link">Rankings</a>
                </div>
            </div>
        </div>
    </div>
                
    <div id="main-content" class="flex-grow">
        <section id="ranking" class="py-12 bg-zwift-dark">
            <div class="container mx-auto px-4">
                <div class="mb-8 border-b border-gray-700 pb-4">
                    <div class="lang-it">
                        <h2 class="text-4xl font-bold text-white font-display">CLASSIFICHE TOUR</h2>
                        <p class="text-gray-400">Seleziona una gara, la classifica e un grupo di etÃ  per visualizzare i risultati aggiornati.</p>
                    </div>
                    <div class="lang-en" hidden>
                        <h2 class="text-4xl font-bold text-white font-display">TOUR RANKINGS</h2>
                        <p class="text-gray-400">Select a race, ranking type, and age group to view updated results.</p>
                    </div>
                </div>
                
                <div class="flex space-x-4 mb-4 flex-wrap items-center bg-zwift-card p-4 rounded-lg border border-gray-700">
                    <div class="flex items-center space-x-2">
                        <label for="selectGaraRanking" class="text-gray-400 text-sm font-semibold lang-it">Gara:</label>
                        <label for="selectGaraRanking" class="text-gray-400 text-sm font-semibold lang-en" hidden>Race:</label>
                        <select id="selectGaraRanking" class="bg-zwift-dark text-white border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-zwift-orange">
                            <option value="cumulative" class="lang-it">Generale (Cumulata)</option>
                            <option value="cumulative" class="lang-en" hidden>General (Cumulative)</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="selectCategory" class="text-gray-400 text-sm font-semibold lang-it">Categoria:</label>
                        <label for="selectCategory" class="text-gray-400 text-sm font-semibold lang-en" hidden>Category:</label>
                        <select id="selectCategory" class="bg-zwift-dark text-white border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-zwift-orange"></select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="selectType" class="text-gray-400 text-sm font-semibold lang-it">Classifica:</label>
                        <label for="selectType" class="text-gray-400 text-sm font-semibold lang-en" hidden>Ranking Type:</label>
                        <select id="selectType" class="bg-zwift-dark text-white border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-zwift-orange"></select>
                    </div>
                </div>
                <div id="podium-container-mwt" class="mb-12">
                    <!-- Podio dinamico verrÃ  renderizzato qui -->
                </div>
                <div id="ranking-container" class="bg-zwift-card p-6 rounded-xl border border-gray-800 shadow-lg min-h-[300px] relative">
                </div>
            </div>
        </section>
    </div>

    <footer class="bg-black py-8 border-t border-gray-800"><!-- footer content --></footer>
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden"><!-- modal content --></div>


    <script src="sidebar.js"></script>
    <script>
        let currentCategory = 'A';
        let currentType = 'punti';
        let currentStage = 'cumulative';
        let cumulativeData = null; // Declare global for cumulative data

        // Function to be called when language changes or page loads
        const initializeRanking = async () => {
            // Load cumulative results once on page load if not already loaded
            if (!cumulativeData) {
                try {
                    const response = await fetch('cumulative_results.json');
                    if (!response.ok) throw new Error(`File non trovato: cumulative_results.json`);
                    cumulativeData = await response.json();
                } catch (error) {
                    console.error("Errore caricamento dati cumulativi:", error);
                    // Optionally display an error message
                }
            }

            // Define jersey icons
            const jerseyIcons = {
                punti: '<img src="points.png" alt="Jersey Punti" class="w-12 h-12 mx-auto">',
                tempo: '<img src="time.png" alt="Jersey Generale" class="w-12 h-12 mx-auto">',
                sprinter: '<img src="sprint.png" alt="Jersey Sprinter" class="w-12 h-12 mx-auto">',
                scalatore: '<img src="climb.png" alt="Jersey Scalatore" class="w-12 h-12 mx-auto">'
            };

            // Define age category mapping
            const ageCategoryMap = {
                'A': '0-29', 'B': '30-39', 'C': '40-49', 'D': '50-59', 'E': '60+'
            };
            
            const getLang = () => localStorage.getItem('mwt_lang') || 'it';

            const translations = {
                // General
                'loading_ranking': { it: 'Caricamento classifica...', en: 'Loading ranking...' },
                'file_not_found': { it: 'File non trovato:', en: 'File not found:' },
                'error_loading_cumulative_data': { it: 'Errore caricamento dati cumulativi:', en: 'Error loading cumulative data:' },
                'invalid_ranking_type': { it: 'Tipo classifica non valido.', en: 'Invalid ranking type.' },
                'no_data_available': { it: 'Nessun dato disponibile per questa selezione.', en: 'No data available for this selection.' },
                'individual': { it: 'Individuale', en: 'Individual' },
                'error_loading_ranking': { it: 'Errore caricamento classifica:', en: 'Error loading ranking:' },
                'ensure_json_files': { it: 'Assicurati che i file JSON per la gara selezionata siano presenti nella directory principale.', en: 'Ensure JSON files for the selected race are present in the main directory.' },
                'unrecognized_json_format': { it: 'Formato JSON della gara singola non riconosciuto.', en: 'Unrecognized single race JSON format.' },
                // Table Headers
                'pos': { it: 'Pos', en: 'Pos' },
                'athlete': { it: 'Atleta', en: 'Athlete' },
                'team': { it: 'Squadra', en: 'Team' },
                'points': { it: 'Punti', en: 'Points' },
                'time': { it: 'Tempo', en: 'Time' },
                'sprint_points': { it: 'Punti Sprint', en: 'Sprint Points' },
                'climb_points': { it: 'Punti Scalata', en: 'Climb Points' },
                'general_points': { it: 'Punti Generali', en: 'General Points' },
                'race_prefix': { it: 'Gara', en: 'Race' },
                'general_suffix': { it: 'Generali', en: 'General' },
                // Dropdown Options
                'cumulative_general': { it: 'Generale (Cumulata)', en: 'General (Cumulative)' },
                'time_ranking': { it: 'Tempo', en: 'Time' },
                'points_ranking': { it: 'Punti Generali', en: 'General Points' },
                'sprinter_ranking': { it: 'Punti Sprinter', en: 'Sprinter Points' },
                'climber_ranking': { it: 'Punti Scalatore', en: 'Climber Points' },
                // Labels
                'gara_label': { it: 'Gara:', en: 'Race:' },
                'category_label': { it: 'Categoria:', en: 'Category:' },
                'ranking_label': { it: 'Classifica:', en: 'Ranking:' },
                'tour_ranking_title': { it: 'CLASSIFICHE TOUR', en: 'TOUR RANKINGS' },
                'tour_ranking_description': { it: 'Seleziona una gara, la classifica e un grupo di etÃ  per visualizzare i risultati aggiornati.', en: 'Select a race, ranking type, and age group to view updated results.' },
            };

            const t = (key) => {
                const lang = getLang();
                return translations[key] ? translations[key][lang] : key;
            };

            const secondsToHms = (d) => {
                if (d === undefined || d === null || isNaN(d) || d === 0) return "--:--:--";
                const h = Math.floor(d / 3600);
                const m = Math.floor((d % 3600) / 60);
                const s = Math.round(d % 60);
                const pad = (num) => String(num).padStart(2, '0');
                return `${pad(h)}:${pad(m)}:${pad(s)}`;
            };

            const renderRankingTable = (data, type, category, stage) => {
                const isCumulative = (stage === 'cumulative');
                let title, headers, scoreKey, unit;

                const singleRaceKeys = { punti: 'punti_total', tempo: 'tempo_time', sprinter: 'sprinter_points', scalatore: 'climber_points' };
                const cumulativeKeys = { punti: 'total', tempo: 'time', sprinter: 'pts_sprint', scalatore: 'pts_kom' };

                if (type === 'punti') { title = t('points'); headers = [t('pos'), t('athlete'), t('team'), t('points')]; unit = ' Pts'; }
                else if (type === 'tempo') { title = t('time'); headers = [t('pos'), t('athlete'), t('team'), t('time')]; unit = ''; }
                else if (type === 'sprinter') { title = t('sprint_points'); headers = [t('pos'), t('athlete'), t('team'), t('sprint_points')]; unit = ' Pts'; }
                else if (type === 'scalatore') { title = t('climb_points'); headers = [t('pos'), t('athlete'), t('team'), t('climb_points')]; unit = ' Pts'; }
                else { return `<p class="text-red-500">${t('invalid_ranking_type')}</p>`; }

                scoreKey = isCumulative ? cumulativeKeys[type] : singleRaceKeys[type];
                title = isCumulative ? `${title} ${t('general_suffix')}` : `${t('race_prefix')} ${stage} - ${title}`;

                const sortedData = [...data].sort((a, b) => {
                    const scoreA = a[scoreKey] || 0;
                    const scoreB = b[scoreKey] || 0;
                    if (type === 'tempo') { return (scoreA || Infinity) - (scoreB || Infinity); }
                    return scoreB - scoreA;
                });

                const categoryDisplayName = ageCategoryMap[category] || category;
                let html = `<div class="overflow-x-scroll"><table class="min-w-full table-auto text-left"><thead><tr class="bg-black/50">
                            ${headers.map(h => `<th class="px-4 py-2 border-b-2 border-zwift-orange">${h}</th>`).join('')}
                            </tr></thead><tbody>`;

                if (sortedData.length === 0) {
                     html += `<tr><td colspan="${headers.length}" class="text-center py-8 text-gray-500">${t('no_data_available')}</td></tr>`;
                } else {
                    sortedData.forEach((athlete, index) => {
                        const rank = index + 1;
                        let scoreDisplay = athlete[scoreKey] || 0;
                        if (type === 'tempo') { scoreDisplay = secondsToHms(scoreDisplay); }
                        else { scoreDisplay += unit; }
                        let rowStyle = '', rankColor = 'text-white', medalIcon = '';

                        if (rank === 1) {
                            rowStyle = 'background-color: rgba(255, 215, 0, 0.2);';
                            rankColor = 'text-yellow-400';
                            medalIcon = 'ðŸ¥‡ ';
                        }
                        else if (rank === 2) { rowStyle = 'background-color: rgba(192, 192, 192, 0.2);'; rankColor = 'text-gray-300'; medalIcon = 'ðŸ¥ˆ '; }
                        else if (rank === 3) { rowStyle = 'background-color: rgba(205, 127, 50, 0.2);'; rankColor = 'text-amber-500'; medalIcon = 'ðŸ¥‰ '; }

                        const flagImg = athlete.flag ? `<img src="https://flagcdn.com/16x12/${athlete.flag.toLowerCase()}.png" alt="${athlete.flag}" class="inline-block mr-2">` : '';

                        html += `<tr class="hover:bg-black/30" style="${rowStyle}">
                                    <td class="px-4 py-3 font-bold ${rankColor}">${medalIcon}${rank}</td>
                                    <td class="px-4 py-3 font-semibold text-white">${flagImg}${athlete.name}</td>
                                    <td class="px-4 py-3 text-gray-400">${athlete.tname || t('individual')}</td>
                                    <td class="px-4 py-3 font-bold text-zwift-orange">${scoreDisplay}</td>
                                 </tr>`;
                    });
                }
                html += `</tbody></table></div>`;
                return html;
            };

            const loadRanking = async (category, type, stage) => {
                currentCategory = category;
                currentType = type;
                currentStage = stage;

                // Update select dropdowns to reflect current state
                document.getElementById('selectGaraRanking').value = stage;
                document.getElementById('selectCategory').value = category;
                document.getElementById('selectType').value = type;

                const container = document.getElementById('ranking-container');
                container.innerHTML = `<div class="text-gray-500 absolute inset-0 flex items-center justify-center">${t('loading_ranking')}</div>`;

                try {
                    const isCumulative = stage === 'cumulative';
                    const dataUrl = isCumulative ? 'cumulative_results.json' : `gara_${stage}_results.json`;

                    const response = await fetch(dataUrl);
                    if (!response.ok) throw new Error(`${t('file_not_found')} ${dataUrl}`);

                    const allRankings = await response.json();

                    let dataToRender;
                    if (isCumulative) {
                        dataToRender = allRankings.results[category] || [];
                    } else {
                        if (Array.isArray(allRankings)) {
                            const cumulativeCategoryData = cumulativeData && cumulativeData.results[category] ? cumulativeData.results[category] : [];
                            dataToRender = allRankings.map(rider => {
                                const cumulativeRider = cumulativeCategoryData.find(cr => cr.name === rider.name);
                                return {
                                    ...rider,
                                    flag: cumulativeRider ? cumulativeRider.flag : null,
                                    tname: cumulativeRider ? cumulativeRider.tname : null,
                                    fin_points: cumulativeRider ? cumulativeRider.fin_points : null,
                                    pts_fal: cumulativeRider ? cumulativeRider.pts_fal : null,
                                    pts_fts: cumulativeRider ? cumulativeRider.pts_fts : null
                                };
                            });
                            dataToRender = dataToRender.filter(rider => rider.category === category);
                        } else if (typeof allRankings === 'object' && allRankings !== null) {
                            const cumulativeCategoryData = cumulativeData && cumulativeData.results[category] ? cumulativeData.results[category] : [];
                            dataToRender = (allRankings[category] && allRankings[category][type]) ? allRankings[category][type] : [];
                            dataToRender = dataToRender.map(rider => {
                                const cumulativeRider = cumulativeCategoryData.find(cr => cr.name === rider.name);
                                return {
                                    ...rider,
                                    flag: cumulativeRider ? cumulativeRider.flag : null,
                                    tname: cumulativeRider ? cumulativeRider.tname : null,
                                    fin_points: cumulativeRider ? cumulativeRider.fin_points : null,
                                    pts_fal: cumulativeRider ? cumulativeRider.pts_fal : null,
                                    pts_fts: cumulativeRider ? cumulativeRider.pts_fts : null
                                };
                            });
                        } else {
                            throw new Error(t('unrecognized_json_format'));
                        }
                    }

                    container.innerHTML = renderRankingTable(dataToRender, type, category, stage);

                } catch (error) {
                    console.error(`${t('error_loading_ranking')} ${error}`);
                    container.innerHTML = `<p class="text-red-500 text-lg p-10">${t('error_loading_ranking')} ${t('ensure_json_files')} (Dettaglio: ${error.message})</p>`;
                }
            };

            const initRankingListeners = () => {
                const selectGaraRanking = document.getElementById('selectGaraRanking');
                const selectCategory = document.getElementById('selectCategory');
                const selectType = document.getElementById('selectType');

                // Clear previous options from dynamic selects (after static one)
                while (selectGaraRanking.options.length > 1) { selectGaraRanking.remove(1); }
                while (selectCategory.options.length > 0) { selectCategory.remove(0); }
                while (selectType.options.length > 0) { selectType.remove(0); }

                // Populate Gara dropdown
                const stageNames = Array.from({length: 18}, (_, i) => `${t('race_prefix')} ${i + 1}`);
                stageNames.forEach((name, index) => {
                    selectGaraRanking.appendChild(new Option(name, index + 1));
                });
                // Add cumulative option back, as it might have been removed by clear
                if(!selectGaraRanking.querySelector('option[value="cumulative"]')) {
                    const cumulativeOption = document.createElement('option');
                    cumulativeOption.value = 'cumulative';
                    cumulativeOption.textContent = t('cumulative_general');
                    selectGaraRanking.prepend(cumulativeOption);
                }


                // Populate Category dropdown
                for (const key in ageCategoryMap) {
                    selectCategory.appendChild(new Option(ageCategoryMap[key], key));
                }

                // Populate Type dropdown
                const typeOptions = [
                    { value: 'punti', text: t('points_ranking') },
                    { value: 'tempo', text: t('time_ranking') },
                    { value: 'sprinter', text: t('sprinter_ranking') },
                    { value: 'scalatore', text: t('climber_ranking') }
                ];
                typeOptions.forEach(option => {
                    selectType.appendChild(new Option(option.text, option.value));
                });


                // Add event listeners for dropdowns
                selectGaraRanking.addEventListener('change', (e) => {
                    currentStage = e.target.value;
                    loadRanking(currentCategory, currentType, currentStage);
                });

                selectCategory.addEventListener('change', (e) => {
                    currentCategory = e.target.value;
                    loadRanking(currentCategory, currentType, currentStage);
                });

                selectType.addEventListener('change', (e) => {
                    currentType = e.target.value;
                    loadRanking(currentCategory, currentType, currentStage);
                });
            };

            document.addEventListener('DOMContentLoaded', () => {
                initRankingListeners();
                loadRanking('A', 'punti', 'cumulative'); // Initial load
            });

            // Generic language switching script
            (function(){
                const btnIt = document.getElementById('btn-it');
                const btnEn = document.getElementById('btn-en');

                function setLanguage(lang, persist = true){
                    const isItalian = lang === 'it';
                    
                    btnIt.setAttribute('aria-pressed', isItalian);
                    btnEn.setAttribute('aria-pressed', !isItalian);
                    
                    document.documentElement.lang = lang;

                    if (persist) {
                        try { localStorage.setItem('mwt_lang', lang); } catch(e){}
                    }
                    
                    // Trigger a reload of dynamic content
                    initRankingListeners(); // Re-populate dropdowns with translated text
                    loadRanking(currentCategory, currentType, currentStage); // Re-render table with translated text
                }

                try{
                    const saved = localStorage.getItem('mwt_lang');
                    if(saved === 'en') setLanguage('en', false);
                    else setLanguage('it', false);
                } catch(e){
                    setLanguage('it', false);
                }

                btnIt.addEventListener('click', ()=> setLanguage('it'));
                btnEn.addEventListener('click', ()=> setLanguage('en'));

                document.addEventListener('keydown', (e)=>{
                    if(e.key === 'ArrowRight' || e.key === 'ArrowLeft'){
                        const current = (localStorage.getItem('mwt_lang') || 'it') === 'en' ? 'en' : 'it';
                        setLanguage(current === 'it' ? 'en' : 'it');
                    }
                });
            })();
    </script>