<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classifiche Masters Winter Tour 2025/26</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="sidebar.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        zwift: { dark: '#111111', card: '#1e1e24', orange: '#fc6719', blue: '#00f0ff', text: '#f0f0f0', gray: '#888888' },
                        race: { flat: '#10b981', mountain: '#ef4444', hilly: '#f59e0b', time: '#00f0ff', }
                    },
                    fontFamily: { display: ['Teko', 'sans-serif'], body: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        /* Ensure main content is flex and takes full width on mobile, and shifts on desktop */
        body { display: flex; min-height: 100vh; flex-direction: column; }

        @media (min-width: 1024px) {
            body { flex-direction: row; } /* Desktop layout with sidebar beside content */
            body > nav { /* Target the direct child nav of body */
                margin-left: 300px;
                width: calc(100% - 300px); /* Ensure it doesn't overflow */
            }
            #main-content { margin-left: 300px; }
        }
        .lang-toggle {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .lang-btn {
            border: none;
            background: transparent;
            font-size: 1.25rem; /* text-xl */
            cursor: pointer;
            padding: 0.375rem; /* p-1.5 */
            border-radius: 0.375rem; /* rounded-md */
            color: #d1d5db; /* gray-300 */
        }
        .lang-btn[aria-pressed="true"] {
            outline: 2px solid rgba(0, 102, 34, 0.2); /* Accent green, transparent */
            background: rgba(0, 102, 34, 0.1); /* Accent green, transparent */
            color: #fc6719; /* zwift-orange to highlight active */
        }
        .lang-btn:focus { box-shadow: 0 0 0 3px rgba(252, 103, 25, 0.3); /* zwift-orange focus */ }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col bg-zwift-dark font-body text-zwift-text">

    <nav class="bg-zwift-card border-b border-gray-800 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-2xl font-bold tracking-wider font-display text-zwift-orange">MASTER WINTER TOUR <span class="text-white text-lg font-light">2025/26</span></div>
                        <div class="flex space-x-3 items-center">
                            <!-- Language toggle button -->
                            <button id="lang-toggle-btn" class="lang-btn" aria-label="Change language">
                                <span id="lang-icon">ðŸ‡®ðŸ‡¹</span>
                            </button>
                            <button id="menu-toggle" class="text-white text-2xl lg:hidden focus:outline-none ml-3">
                                <span id="menu-icon-open"><i class="fas fa-bars"></i></span>
                                <span id="menu-icon-close" class="hidden"><i class="fas fa-times"></i></span>
                            </button>
                        </div>
                    </div>
                </nav>
                
    <div id="sidebar-overlay" class="fixed inset-0 bg-black z-40 transition-opacity duration-300 hidden"></div>
    <div id="sidebar" class="fixed top-0 left-0 w-72 h-full bg-[#1a1d20] shadow-2xl z-50 transform -translate-x-full transition-transform duration-300 ease-in-out">
        <div class="p-4 border-b border-gray-700 sticky top-0 bg-[#1a1d20]">
            <div class="flex items-center space-x-2">
                <img src="https://www.teaminox.it/wp-content/uploads/2023/11/cropped-INOX-semplice-colore-lineare.png" class="h-8" alt="Logo INOX">

            </div>
        </div>
        <div class="flex flex-col p-2 space-y-1 text-base font-semibold">
            <div class="border-b border-gray-700 pb-2 mb-2">
                <p class="text-xs text-gray-500 uppercase px-3 py-1">Navigazione</p>

                <a href="mwt_page.html" class="sidebar-link">Masters Winter Tour</a>
                <a href="regolamento.html" class="sidebar-link">Regolamento</a>
                <a href="Leaders.html" class="sidebar-link">Leaders del Tour</a>


                <a href="ranking.html" class="sidebar-link">Classifiche</a>
            </div>
        </div>
    </div>
                
    <div id="main-content" class="flex-grow">
        <section id="ranking" class="py-12 bg-zwift-dark">
            <div class="container mx-auto px-4">
                <div class="mb-8 border-b border-gray-700 pb-4">
                    <h2 class="text-4xl font-bold text-white font-display lang-it">CLASSIFICHE TOUR</h2>
                    <p class="text-gray-400 lang-it">Seleziona una gara, la classifica e un grupo di etÃ  per visualizzare i risultati aggiornati.</p>
                    <h2 class="text-4xl font-bold text-white font-display lang-en" hidden>TOUR RANKINGS</h2>
                    <p class="text-gray-400 lang-en" hidden>Select a race, ranking, and age group to view updated results.</p>
                </div>
                
                <div class="flex space-x-4 mb-4 flex-wrap items-center bg-zwift-card p-4 rounded-lg border border-gray-700">
                    <div class="flex items-center space-x-2">
                        <label for="selectGaraRanking" class="text-gray-400 text-sm font-semibold lang-it">Gara:</label>
                        <label for="selectGaraRanking" class="text-gray-400 text-sm font-semibold lang-en" hidden>Race:</label>
                        <select id="selectGaraRanking" class="bg-zwift-dark text-white border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-zwift-orange">
                            <option value="cumulative" class="lang-it">Generale (Cumulata)</option>
                            <option value="cumulative" class="lang-en" hidden>General (Cumulative)</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="selectCategory" class="text-gray-400 text-sm font-semibold lang-it">Categoria:</label>
                        <label for="selectCategory" class="text-gray-400 text-sm font-semibold lang-en" hidden>Category:</label>
                        <select id="selectCategory" class="bg-zwift-dark text-white border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-zwift-orange"></select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="selectType" class="text-gray-400 text-sm font-semibold lang-it">Classifica:</label>
                        <label for="selectType" class="text-gray-400 text-sm font-semibold lang-en" hidden>Ranking:</label>
                        <select id="selectType" class="bg-zwift-dark text-white border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-zwift-orange"></select>
                    </div>
                </div>
                <div id="event-details-container" class="bg-zwift-card p-6 rounded-xl border border-gray-800 shadow-lg mb-8" style="display: none;">
                <h3 class="text-2xl font-bold text-white font-display mb-2" id="event-title"></h3>
                <p class="text-gray-400 text-sm" id="event-route"></p>
                <p class="text-gray-400 text-sm" id="event-distance-elevation"></p>
                <p class="text-gray-400 text-sm" id="event-start-time"></p>
                <div id="event-description" class="text-gray-500 text-xs mt-4"></div>
            </div>
            <div id="podium-container-mwt" class="mb-12">
                    <!-- Podio dinamico verrÃ  renderizzato qui -->
                </div>
                <div id="ranking-container" class="bg-zwift-card p-6 rounded-xl border border-gray-800 shadow-lg min-h-[300px] relative">
                </div>
            </div>
        </section>
    </div>

    <footer class="bg-black py-8 border-t border-gray-800"><!-- footer content --></footer>
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden"><!-- modal content --></div>

    <!-- Rider Details Popup -->
    <div id="rider-popup" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div id="rider-popup-content" class="bg-zwift-card rounded-lg shadow-xl border border-gray-700 w-full max-w-lg p-6 relative m-4">
            <button id="rider-popup-close" class="absolute top-3 right-3 text-gray-500 hover:text-white text-2xl">&times;</button>
            <h3 id="rider-popup-name" class="text-2xl font-bold text-zwift-orange font-display mb-4"></h3>
            <div id="rider-popup-details" class="text-sm"></div>
        </div>
    </div>


    <script src="sidebar.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const getLang = () => localStorage.getItem('mwt_lang') || 'it';

            const translations = {
                'loading_ranking': { it: 'Caricamento classifica...', en: 'Loading ranking...' }, 'file_not_found': { it: 'File non trovato:', en: 'File not found:' },
                'error_loading_cumulative_data': { it: 'Errore caricamento dati cumulativi:', en: 'Error loading cumulative data:' },
                'invalid_ranking_type': { it: 'Tipo classifica non valido.', en: 'Invalid ranking type.' }, 'no_data_available': { it: 'Nessun dato disponibile per questa selezione.', en: 'No data available for this selection.' },
                'individual': { it: 'Individuale', en: 'Individual' }, 'error_loading_ranking': { it: 'Errore caricamento classifica:', en: 'Error loading ranking:' },
                'ensure_json_files': { it: 'Assicurati che i file JSON siano presenti.', en: 'Ensure JSON files are present.' },
                'unrecognized_json_format': { it: 'Formato JSON non riconosciuto.', en: 'Unrecognized JSON format.' },
                'pos': { it: 'Pos', en: 'Pos' }, 'athlete': { it: 'Atleta', en: 'Athlete' }, 'team': { it: 'Squadra', en: 'Team' }, 'points': { it: 'Punti', en: 'Points' },
                'time': { it: 'Tempo', en: 'Time' }, 'sprint_points': { it: 'Punti Sprint', en: 'Sprint Points' }, 'climb_points': { it: 'Punti Scalata', en: 'Climb Points' },
                'race_prefix': { it: 'Gara', en: 'Race' }, 'general_suffix': { it: 'Generali', en: 'General' },
                'cumulative_general': { it: 'Generale (Cumulata)', en: 'General (Cumulative)' }, 'time_ranking': { it: 'Tempo', en: 'Time' },
                'points_ranking': { it: 'Punti', en: 'Points' }, 'sprinter_ranking': { it: 'Punti Sprinter', en: 'Sprinter Points' },
                'climber_ranking': { it: 'Punti Scalatore', en: 'Climber Points' },
                'race': { it: 'Gara', en: 'Race' }, 'stage': { it: 'Tappa', en: 'Stage' }, 'rider_time': { it: 'Tempo Atleta', en: 'Rider Time' },
                'loading_details': { it: 'Caricamento dettagli...', en: 'Loading details...' },
                'no_participation': { it: 'Non ha partecipato', en: 'Did not participate' },
                'last_place_time_in_category': { it: 'Tempo dell\'ultimo classificato di categoria', en: 'Last-place time in category' }
            };

            const t = (key) => {
                const lang = getLang();
                return translations[key]?.[lang] || translations[key]?.it || key;
            };

            let cumulativeData = null;
            try {
                const response = await fetch('cumulative_results.json');
                if (!response.ok) throw new Error(`${t('file_not_found')} cumulative_results.json`);
                cumulativeData = await response.json();
            } catch (error) { console.error(t('error_loading_cumulative_data'), error); }

            const ageCategoryMap = { 'A': '0-29', 'B': '30-39', 'C': '40-49', 'D': '50-59', 'E': '60+' };
            let currentCategory = 'A', currentType = 'punti', currentStage = 'cumulative';

            const secondsToHms = (d) => {
                if (d === undefined || d === null || isNaN(d) || d === 0) return "--:--:--";
                const h = Math.floor(d / 3600), m = Math.floor((d % 3600) / 60), s = Math.round(d % 60);
                const pad = (num) => String(num).padStart(2, '0');
                return `${pad(h)}:${pad(m)}:${pad(s)}`;
            };

            const renderRankingTable = (data, type, stage) => {
                const isCumulative = stage === 'cumulative';
                const scoreKeys = { punti: {c: 'total', s: 'punti_total'}, tempo: {c: 'time', s: 'tempo_time'}, sprinter: {c: 'pts_sprint', s: 'sprinter_points'}, scalatore: {c: 'pts_kom', s: 'climber_points'} };
                const headers = { punti: [t('pos'), t('athlete'), t('team'), t('points')], tempo: [t('pos'), t('athlete'), t('team'), t('time')], sprinter: [t('pos'), t('athlete'), t('team'), t('sprint_points')], scalatore: [t('pos'), t('athlete'), t('team'), t('climb_points')] };
                const scoreKey = isCumulative ? scoreKeys[type].c : scoreKeys[type].s;
                const tableHeaders = headers[type] || [];
                
                let filteredData = [...data];
                if (type === 'tempo') {
                    // Filter for 'tempo' ranking: only include riders with a valid time > 0
                    filteredData = filteredData.filter(athlete => 
                        athlete[scoreKey] !== undefined && athlete[scoreKey] !== null && athlete[scoreKey] > 0
                    );
                }
                
                const sortedData = filteredData.sort((a, b) => {
                    const scoreA = a[scoreKey] || (type === 'tempo' ? Infinity : 0);
                    const scoreB = b[scoreKey] || (type === 'tempo' ? Infinity : 0);
                    return type === 'tempo' ? scoreA - scoreB : scoreB - scoreA;
                });

                let html = `<div class="overflow-x-scroll"><table class="min-w-full table-auto text-left"><thead><tr class="bg-black/50">${tableHeaders.map(h => `<th class="px-4 py-2 border-b-2 border-zwift-orange">${h}</th>`).join('')}</tr></thead><tbody>`;
                if (sortedData.length === 0) {
                    html += `<tr><td colspan="${tableHeaders.length}" class="text-center py-8 text-gray-500">${t('no_data_available')}</td></tr>`;
                } else {
                    sortedData.forEach((athlete, index) => {
                        const rank = index + 1, scoreDisplay = type === 'tempo' ? secondsToHms(athlete[scoreKey]) : `${athlete[scoreKey] || 0} Pts`;
                        const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'], medalIcon = rank <= 3 ? medals[rank - 1] : '';
                        const flagImg = athlete.flag ? `<img src="https://flagcdn.com/16x12/${athlete.flag.toLowerCase()}.png" alt="${athlete.flag}" class="inline-block mr-2">` : '';
                        const cursorClass = type === 'tempo' && isCumulative ? 'cursor-pointer' : '';
                        html += `<tr class="hover:bg-black/30 ${cursorClass}" data-rider-zwid="${athlete.zwid}" data-rider-name="${athlete.name}"><td class="px-4 py-3 font-bold">${medalIcon}${rank}</td><td class="px-4 py-3 font-semibold text-white">${flagImg}${athlete.name}</td><td class="px-4 py-3 text-gray-400">${athlete.tname || t('individual')}</td><td class="px-4 py-3 font-bold text-zwift-orange">${scoreDisplay}</td></tr>`;
                    });
                }
                html += `</tbody></table></div>`;
                return html;
            };

            const loadRanking = async (category, type, stage) => {
                currentCategory = category; currentType = type; currentStage = stage;
                const container = document.getElementById('ranking-container');
                const eventDetailsContainer = document.getElementById('event-details-container');
                container.innerHTML = `<div class="text-gray-500 absolute inset-0 flex items-center justify-center">${t('loading_ranking')}</div>`;
                eventDetailsContainer.style.display = 'none'; // Nasconde i dettagli dell'evento di default

                try {
                    const isCumulative = stage === 'cumulative';
                    const dataUrl = isCumulative ? 'cumulative_results.json' : `gara_${stage}_results.json`;
                    const response = await fetch(dataUrl);
                    if (!response.ok) throw new Error(`${t('file_not_found')} ${dataUrl}`);
                    const jsonData = await response.json();
                    let dataToRender;

                    if (isCumulative) {
                        dataToRender = jsonData.results[category] || [];
                        renderEventDetails(null);
                    } else {
                        const eventDetails = jsonData.event_details;
                        const raceResults = jsonData.race_results;
                        renderEventDetails(eventDetails);
                        dataToRender = raceResults.filter(rider => rider.category === category);
                    }
                    container.innerHTML = renderRankingTable(dataToRender, type, stage);
                } catch (error) {
                    console.error(t('error_loading_ranking'), error);
                    container.innerHTML = `<p class="text-red-500 text-lg p-10">${t('error_loading_ranking')} (${error.message})</p>`;
                    renderEventDetails(null);
                }
            };
            
            const showRiderDetailsPopup = async (riderZwid, riderName) => {
                const popup = document.getElementById('rider-popup');
                const popupName = document.getElementById('rider-popup-name');
                const popupDetails = document.getElementById('rider-popup-details');

                popupName.textContent = riderName;
                popupDetails.innerHTML = `<div class="text-gray-400">${t('loading_details')}</div>`;
                popup.classList.remove('hidden');

                const numGare = 18; // Assuming up to 18 races
                const promises = [];
                for (let i = 1; i <= numGare; i++) {
                    promises.push(fetch(`gara_${i}_results.json`).catch(() => null));
                }

                const responses = await Promise.all(promises);
                const raceData = await Promise.all(responses.map(res => res ? res.json().catch(() => null) : null));

                let detailsHtml = '<table class="w-full text-left"><thead><tr class="border-b border-gray-600"><th class="py-2 pr-4">' + t('stage') + '</th><th class="py-2">' + t('rider_time') + '</th></tr></thead><tbody>';

                raceData.forEach((data, index) => {
                    if (data && data.race_results) {
                        const stageNum = index + 1;
                        const riderResult = data.race_results.find(r => r.zwid == riderZwid);
                        let timeHtml;

                        if (riderResult && riderResult.tempo_time > 0) {
                            timeHtml = secondsToHms(riderResult.tempo_time);
                        } else {
                            const categoryResults = data.race_results.filter(r => r.category === currentCategory);
                            const validTimes = categoryResults.map(r => r.tempo_time).filter(t => t && t > 0);

                            if (validTimes.length > 0) {
                                const lastPlaceTime = Math.max(...validTimes);
                                const titleText = t('last_place_time_in_category');
                                timeHtml = `<i class="text-gray-500" title="${titleText}">${secondsToHms(lastPlaceTime)}</i>`;
                            } else {
                                timeHtml = `<span class="text-gray-500">${t('no_participation')}</span>`;
                            }
                        }
                        
                        const stageTitle = data.event_details.title || `${t('race')} ${stageNum}`;
                        detailsHtml += `<tr class="border-b border-gray-800"><td class="py-2 pr-4">${stageTitle}</td><td class="font-mono text-right">${timeHtml}</td></tr>`;
                    }
                });

                detailsHtml += '</tbody></table>';
                popupDetails.innerHTML = detailsHtml;
            };

            const initPopupListeners = () => {
                const rankingContainer = document.getElementById('ranking-container');
                const popup = document.getElementById('rider-popup');
                const closeBtn = document.getElementById('rider-popup-close');

                rankingContainer.addEventListener('click', (e) => {
                    if (currentType === 'tempo' && currentStage === 'cumulative') {
                        const row = e.target.closest('tr');
                        if (row && row.dataset.riderZwid) {
                            showRiderDetailsPopup(row.dataset.riderZwid, row.dataset.riderName);
                        }
                    }
                });

                const closePopup = () => popup.classList.add('hidden');
                closeBtn.addEventListener('click', closePopup);
                popup.addEventListener('click', (e) => {
                    if (e.target.id === 'rider-popup') {
                        closePopup();
                    }
                });
            };

            const renderEventDetails = (eventDetails) => {
                const eventDetailsContainer = document.getElementById('event-details-container');
                if (!eventDetails) {
                    eventDetailsContainer.style.display = 'none';
                    return;
                }
                eventDetailsContainer.style.display = 'block';

                document.getElementById('event-title').textContent = eventDetails.title || '';
                document.getElementById('event-route').textContent = eventDetails.route ? `Percorso: ${eventDetails.route}` : '';
                
                const startTime = eventDetails.start_time ? new Date(eventDetails.start_time).toLocaleString('it-IT') : '';
                document.getElementById('event-start-time').textContent = startTime ? `Ora di inizio: ${startTime}` : '';
            };

            const initRankingListeners = () => {
                const selectGaraRanking = document.getElementById('selectGaraRanking');
                const selectCategory = document.getElementById('selectCategory');
                const selectType = document.getElementById('selectType');

                const populateSelect = (select, options) => {
                    select.innerHTML = '';
                    options.forEach(opt => select.appendChild(new Option(opt.text, opt.value)));
                };
                
                populateSelect(selectGaraRanking, [{text: t('cumulative_general'), value: 'cumulative'}, ...Array.from({length: 18}, (_, i) => ({ text: `${t('race_prefix')} ${i + 1}`, value: i + 1 }))]);
                populateSelect(selectCategory, Object.keys(ageCategoryMap).map(key => ({ text: ageCategoryMap[key], value: key })));
                populateSelect(selectType, [
                    { value: 'tempo', text: t('time_ranking') },
                    { value: 'punti', text: t('points_ranking') },
                    { value: 'sprinter', text: t('sprinter_ranking') },
                    { value: 'scalatore', text: t('climber_ranking') }
                ]);

                selectGaraRanking.value = currentStage;
                selectCategory.value = currentCategory;
                selectType.value = currentType;
                
                selectGaraRanking.onchange = (e) => loadRanking(currentCategory, currentType, e.target.value);
                selectCategory.onchange = (e) => loadRanking(e.target.value, currentType, currentStage);
                selectType.onchange = (e) => loadRanking(currentCategory, e.target.value, currentStage);
            };

            const setLanguage = (lang) => {
                localStorage.setItem('mwt_lang', lang);
                document.documentElement.lang = lang;
                document.querySelectorAll('.lang-it').forEach(el => el.hidden = lang !== 'it');
                document.querySelectorAll('.lang-en').forEach(el => el.hidden = lang !== 'en');
                
                const langIcon = document.getElementById('lang-icon');
                if (langIcon) {
                    langIcon.textContent = lang === 'it' ? 'ðŸ‡®ðŸ‡¹' : 'ðŸ‡¬ðŸ‡§';
                }

                initRankingListeners();
                loadRanking(currentCategory, currentType, currentStage);
            };
            
            const langToggleBtn = document.getElementById('lang-toggle-btn');
            if (langToggleBtn) {
                langToggleBtn.addEventListener('click', () => {
                    const currentLang = getLang();
                    const newLang = currentLang === 'it' ? 'en' : 'it';
                    setLanguage(newLang);
                });
            }
            
            initPopupListeners(); // Initialize popup listeners
            setLanguage(getLang()); // Initial setup
        });
    </script>